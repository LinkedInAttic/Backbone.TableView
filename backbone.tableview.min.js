(function(){var s={}.hasOwnProperty,g=function(e,a){function b(){this.constructor=e}for(var c in a)s.call(a,c)&&(e[c]=a[c]);b.prototype=a.prototype;e.prototype=new b;e.__super__=a.prototype;return e},k=[].slice;Backbone.TableView=function(e){function a(){var b=this;this.onUpdated=function(){return a.prototype.onUpdated.apply(b,arguments)};this.onUpdating=function(){return a.prototype.onUpdating.apply(b,arguments)};this.showLoading=function(){return a.prototype.showLoading.apply(b,arguments)};this.render=
function(){return a.prototype.render.apply(b,arguments)};this.toggleSort=function(c){return a.prototype.toggleSort.apply(b,arguments)};this.nextPage=function(){return a.prototype.nextPage.apply(b,arguments)};this.prevPage=function(){return a.prototype.prevPage.apply(b,arguments)};this.toPage=function(c){return a.prototype.toPage.apply(b,arguments)};this.renderData=function(){return a.prototype.renderData.apply(b,arguments)};this.refreshPagination=function(){return a.prototype.refreshPagination.apply(b,
arguments)};this.update=function(c,d){return a.prototype.update.apply(b,arguments)};this.updateUrl=function(c){return a.prototype.updateUrl.apply(b,arguments)};this.updateSearch=function(c){return a.prototype.updateSearch.apply(b,arguments)};this.createFilter=function(c,d){return a.prototype.createFilter.apply(b,arguments)};this.setData=function(){1<=arguments.length&&k.call(arguments,0);return a.prototype.setData.apply(b,arguments)};return a.__super__.constructor.apply(this,arguments)}g(a,e);a.prototype.tagName=
"div";a.prototype.titleTemplate=_.template('<div class="<%= classSize %>">\n    <h4 class="<%= model.className || "" %>"><%= model.name || model %></h4>\n</div>');a.prototype.filtersTemplate=_.template('<div class="filters controls tableview-center <%= classSize %>">\n</div>');a.prototype.searchTemplate=_.template('<div class="<%= classSize %>">\n    <input type="text" class="search-query input-block-level pull-right" placeholder="<%= model.detail || model %>" value="<%- data[model.query || "q"] || "" %>"></input>\n</div>');
a.prototype.paginationTemplate=_.template('<div class="row-fluid">\n    <div class="span6">\n        <div class="tableview-info">Showing <%= from %> to <%= to %><%= total %></div>\n    </div>\n    <div class="span6">\n        <div class="pagination tableview-pagination">\n            <ul>\n                <li class="pager-prev <%= prevDisabled %>"><a href="javascript:void(0)">\u2190 Previous</a></li>\n                <% _.each(pages, function (page) { %>\n                    <li class="pager-page <%= page.active %>"><a href="javascript:void(0)"><%= page.number %></a></li>\n                <% }) %>\n                <li class="pager-next <%= nextDisabled %>"><a href="javascript:void(0)">Next \u2192 </a></li>\n            </ul>\n        </div>\n    </div>\n</div>');
a.prototype.emptyTemplate=_.template('<tr>\n    <td colspan="10"><span class="<%= className %>"><%= text %></span></td>\n</tr>');a.prototype.columnsTemplate=_.template('<% _.each(model, function (col, key) { %>\n    <% if (!col.noshow) { %>\n        <th abbr="<%= key || col %>"\n         class="<%= !col.nosort && !self.nosort ? "tableview-sorting" : "" %> <%= ((key || col) == data.sort_col) ? "tableview-sorting-" + data.sort_dir : "" %> <%= col.className || "" %>">\n            <%= col.header || key %>\n        </th>\n    <% } %>\n<% }) %>');
a.prototype.template=_.template('<div class="tableview-container">\n    <div class="loading hide">\n        <span class="tableview-loading-spinner">Loading...</span>\n    </div>\n    <div class="row-fluid">\n        <%= title %>\n\n        <%= filters %>\n\n        <%= search %>\n    </div>\n\n    <table class="table table-striped tableview-table">\n        <thead>\n            <tr>\n                <%= columns %>\n            </tr>\n        </thead>\n        <tbody class="fade">\n        </tbody>\n    </table>\n\n    <div id="pagination-main">\n    </div>\n</div>');
a.prototype.myEvents={"change .search-query":"updateSearch","click  th":"toggleSort","click  .pager-page:not(.active)":"toPage","click  .pager-prev:not(.disabled)":"prevPage","click  .pager-next:not(.disabled)":"nextPage"};a.prototype.initialize=function(){var b,a,d,h,f;d=this.options;for(b in d)a=d[b],this[b]=a;this.filterClasses=_.extend({option:Backbone.TableView.ButtonOptionFilter,dropdown:Backbone.TableView.DropdownFilter,input:Backbone.TableView.InputFilter,button:Backbone.TableView.ButtonFilter,
buttongroup:Backbone.TableView.ButtonGroupFilter},this.filterClasses);this.events=_.extend(_.clone(this.myEvents),this.events);this.collection.on("reset",this.renderData);this.collection.on("add",this.renderData);this.collection.on("remove",this.renderData);this.collection.on("destroy",this.renderData);this.on("updating",this.onUpdating);this.on("updated",this.onUpdated);this.data=_.extend({},this.initialData);this.router&&(this.data=_.extend(this.data,this.parseQueryString(Backbone.history.fragment)));
this.pagination&&(this.data.page=null!=(h=parseInt(this.data.page)||this.page)?h:1,this.data.size=null!=(f=parseInt(this.data.size)||this.size)?f:10);return this};a.prototype.parseQueryString=function(b){var a,d,h,f;h={};if(b&&0<=(a=b.indexOf("?"))){b=b.substring(a+1);f=/([^&=]+)=?([^&]*)/g;for(a=function(b){return decodeURIComponent(b.replace(/\+/g," "))};d=f.exec(b);)h[a(d[1])]=a(d[2])}return h};a.prototype.setData=function(){var b,a,d;b=1<=arguments.length?k.call(arguments,0):[];this.pagination&&
(this.data.page=1);for(;1<b.length;)a=b[0],d=b[1],b=3<=b.length?k.call(b,2):[],null!=d?this.data[a]=d:delete this.data[a];return this.update()};a.prototype.createFilter=function(b,a){var d,h,f,e,l,m,r,g,n,p,k;return new this.filterClasses[a.type]({id:b,extraId:a.extraId,name:null!=(d=a.name)?d:this.prettyName(b),off:null!=(h=a.off)?h:"false",on:null!=(e=a.on)?e:"true",filterClass:null!=(l=a.className)?l:"",options:a.options,init:(null!=(p=a.set)?p:_.identity)(null!=(m=null!=(r=this.data[b])?r:a.init)?
m:"",null!=(g=null!=(n=this.data[a.extraId])?n:a.extraInit)?g:""),setData:this.setData,get:null!=(k=a.get)?k:_.identity,getExtraId:null!=(f=a.getExtraId)?f:_.identity})};a.prototype.updateSearch=function(a){return this.setData(this.search.query||"q",a.currentTarget.value)};a.prototype.updateUrl=function(a){var c,d;if(this.router){d=Backbone.history.fragment;if(0<=(c=d.indexOf("?")))d=d.substring(0,c);(c=$.param(this.data))&&(d+="?"+c);this.router.navigate(d,{replace:a})}return this};a.prototype.update=
function(a,c){this.trigger("updating");this.updateUrl(a);c?this.renderData():this.noFetch||this.collection.fetch({data:("function"===typeof this.filterData?this.filterData(_.clone(this.data)):void 0)||this.data});return this};a.prototype.refreshPagination=function(){var a,c,d,h,f,e;this.data.page=parseInt("function"===typeof(a=this.collection).getData?a.getData("page"):void 0)||this.data.page;this.data.size=parseInt("function"===typeof(d=this.collection).getData?d.getData("size"):void 0)||this.data.size;
a=(this.data.page-1)*this.data.size;e=a+this.collection.size();0<this.collection.size()&&a++;d=null!=this.collection.count?_.result(this.collection,"count"):-1;0>d?(f=c=this.data.page,h=""):(h=Math.ceil(d/this.data.size)||1,c=_.max([1,this.data.page-2-_.max([0,2+this.data.page-h])]),f=_.min([h,this.data.page+2+_.max([0,3-this.data.page])]),h=" of "+d+" entries");var l,m,g;m=_.range(c,f+1);g=[];f=0;for(l=m.length;f<l;f++)c=m[f],g.push({number:c,active:c===this.data.page&&"active"||""});this.$("#pagination-main").html(this.paginationTemplate({from:a,
to:e,total:h,prevDisabled:1===this.data.page?"disabled":"",nextDisabled:e===d?"disabled":"",pages:g}));return this};a.prototype.renderData=function(){var a,c,d,e,f,g,l,m,k,q,n,p;a=this.$("tbody");if(0===this.collection.models.length)a.html(this.emptyTemplate({text:null!=(c=this.empty)?c:"No records to show",className:""}));else{a.html("");k=this.collection.models;l=0;for(m=k.length;l<m;l++){e=k[l];g=$("<tr>");q=this.columns;for(f in q)d=q[f],d.noshow||(c=$("<td>").addClass(d.className).addClass(d.tdClass),
null!=d.draw?c.html(d.draw(e,this)):c.text(null!=(n=e.get(f))?n:""),g.append(c));a.append(null!=(p="function"===typeof this.rowTransformer?this.rowTransformer(g,e):void 0)?p:g)}}this.pagination&&this.refreshPagination();this.trigger("updated");return this};a.prototype.toPage=function(a){return this.setData("page",parseInt(a.currentTarget.childNodes[0].text))};a.prototype.prevPage=function(){if(1<this.data.page)return this.setData("page",this.data.page-1)};a.prototype.nextPage=function(){return this.setData("page",
this.data.page+1)};a.prototype.toggleSort=function(a){var c;a=a.currentTarget;c=a.className;if(0<=c.indexOf("tableview-sorting-asc"))c="desc";else if(0<=c.indexOf("tableview-sorting"))c="asc";else return this;this.$("th").removeClass("tableview-sorting-desc tableview-sorting-asc");this.$(a).addClass("tableview-sorting-"+c);return this.setData("sort_col",a.abbr,"sort_dir",c)};a.prototype.applyTemplate=function(a,c,d){null==d&&(d=12);return c&&d&&a({data:this.data,model:c,classSize:"span"+d,self:this})||
""};a.prototype.render=function(){var a,c,d,e,f,g=this;d=3;a=6;c=3;null==this.search&&(a+=c,c=0);null==this.title?(a+=d,d=0):null==this.filters&&(d+=a,a=0);this.$el.html(this.template({title:this.applyTemplate(this.titleTemplate,this.title,d),search:this.applyTemplate(this.searchTemplate,this.search,c),filters:this.applyTemplate(this.filtersTemplate,this.filters,a),columns:this.applyTemplate(this.columnsTemplate,this.columns)}));c=_.compact(_.map(this.filters,function(a,b){return g.createFilter(b,
a)}));d=this.$(".filters");e=0;for(f=c.length;e<f;e++)a=c[e],d.append(a.render().el);return this.update(!0,this.skipInitialFetch)};a.prototype.prettyName=function(a){return a.charAt(0).toUpperCase()+a.substring(1).replace(/_(\w)/g,function(a,b){return" "+b.toUpperCase()})};a.prototype.showLoading=function(){this.showLoadingTimeout=null;this.$("tbody").removeClass("in");return 0===this.collection.models.length?(this.$(".loading").addClass("hide"),this.$("tbody").html(this.emptyTemplate({text:"Loading...",
className:"tableview-loading-spinner"}))):this.$(".loading").removeClass("hide")};a.prototype.onUpdating=function(){this.showLoadingTimeout&&clearTimeout(this.showLoadingTimeout);return this.showLoadingTimeout=_.delay(this.showLoading,500)};a.prototype.onUpdated=function(){this.showLoadingTimeout&&clearTimeout(this.showLoadingTimeout);this.$("tbody").addClass("in");return this.$(".loading").addClass("hide")};return a}(Backbone.View);Backbone.TableView.Filter=function(e){function a(){var b=this;this.render=
function(){return a.prototype.render.apply(b,arguments)};return a.__super__.constructor.apply(this,arguments)}g(a,e);a.prototype.tagName="div";a.prototype.className="pull-left tableview-filterbox";a.prototype.initialize=function(){this.id=this.options.id;this.extraId=this.options.extraId;this.setData=this.options.setData;return this.options.options=_.map(_.result(this.options,"options"),function(a){_.isArray(a)?a={name:a[0],value:a[1]}:_.isObject(a)||(a={name:a,value:a});return a})};a.prototype.render=
function(){this.$el.html(this.template(this.options));return this};return a}(Backbone.View);Backbone.TableView.InputFilter=function(e){function a(){var b=this;this.update=function(c){return a.prototype.update.apply(b,arguments)};return a.__super__.constructor.apply(this,arguments)}g(a,e);a.prototype.template=_.template('<span class="add-on"><%= name %></span><input type="text" class="filter <%= filterClass %>" value="<%= init %>"></input>');a.prototype.className="input-prepend pull-left tableview-filterbox";
a.prototype.events={"change .filter":"update"};a.prototype.update=function(a){return this.extraId?this.setData(this.id,this.options.get(a.currentTarget.value),this.extraId,this.options.getExtraId(a.currentTarget.value)):this.setData(this.id,this.options.get(a.currentTarget.value))};return a}(Backbone.TableView.Filter);Backbone.TableView.ButtonFilter=function(e){function a(){var b=this;this.update=function(c){return a.prototype.update.apply(b,arguments)};return a.__super__.constructor.apply(this,arguments)}
g(a,e);a.prototype.template=_.template('<button type="button" class="filter btn <%= init == on ? "active" : "" %> <%= filterClass %>"><%= name %></button>');a.prototype.events={"click .filter":"update"};a.prototype.initialize=function(){a.__super__.initialize.apply(this,arguments);this.values=[this.options.off,this.options.on];return this.current=this.options.init===this.options.on?1:0};a.prototype.update=function(a){this.$(a.currentTarget).toggleClass("active");this.current=1-this.current;return this.setData(this.id,
this.values[this.current])};return a}(Backbone.TableView.Filter);Backbone.TableView.ButtonGroupFilter=function(e){function a(){var b=this;this.update=function(c){return a.prototype.update.apply(b,arguments)};return a.__super__.constructor.apply(this,arguments)}g(a,e);a.prototype.template=_.template('<% _.each(options, function (el, i) { %>\n    <button class="btn <%= _.contains(init, el.value) ? "active" : "" %> <%= !_.isUndefined(el.className) ? el.className : "" %>" value="<%= el.value %>"><%= el.name %></button>\n<% }) %>');
a.prototype.className="btn-group pull-left tableview-filterbox";a.prototype.events={"click .btn":"update"};a.prototype.update=function(a){var c=this;this.$(a.currentTarget).toggleClass("active");a=_.compact(_.map(this.$(".btn"),function(a){return c.$(a).hasClass("active")?c.$(a).attr("value"):null}));return this.setData(this.id,this.options.get(a))};return a}(Backbone.TableView.Filter);Backbone.TableView.ButtonOptionFilter=function(e){function a(){var b=this;this.update=function(c){return a.prototype.update.apply(b,
arguments)};return a.__super__.constructor.apply(this,arguments)}g(a,e);a.prototype.template=_.template('<% _.each(options, function (el, i) { %>\n    <button class="btn <%= init == el.value ? "active" : "" %>" value="<%= el.value %>"><%= el.name %></button>\n<% }) %>');a.prototype.className="btn-group pull-left tableview-filterbox";a.prototype.events={"click .btn":"update"};a.prototype.update=function(a){this.$(".btn").removeClass("active");this.$(a.currentTarget).addClass("active");return this.setData(this.id,
this.options.get(a.currentTarget.value))};return a}(Backbone.TableView.Filter);Backbone.TableView.DropdownFilter=function(e){function a(){var b=this;this.update=function(c){return a.prototype.update.apply(b,arguments)};return a.__super__.constructor.apply(this,arguments)}g(a,e);a.prototype.template=_.template('<select class="filter <%= filterClass %>">\n    <% _.each(options, function (el, i) { %>\n        <option <%= init == el.value ? "selected=\'selected\'" : "" %> value="<%= el.value %>"><%= el.name %></button>\n    <% }) %>\n</select>');
a.prototype.events={"change .filter":"update"};a.prototype.update=function(a){return this.setData(this.id,this.options.get(a.currentTarget.value))};return a}(Backbone.TableView.Filter)}).call(this);
